<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watson AI Chatbot - Smart Student Helpdesk</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{box-sizing:border-box}
    :root{
      --primary:#7b43ff;
      --secondary:#00bfff;
      --accent:#00ff88;
      --dark:#0a0a0f;
      --light:#ffffff;
      --muted:rgba(255,255,255,0.6)
    }
    
    html,body{
      height:100%;
      margin:0;
      font-family:'Poppins',sans-serif;
      background:var(--dark);
      color:var(--light);
      overflow:hidden;
    }
    
    .gradient-bg{
      position:fixed;
      inset:0;
      background:linear-gradient(135deg,var(--dark) 0%,#1a0b2e 25%,#2d1b4e 50%,#1a0b2e 75%,var(--dark) 100%);
      z-index:-2
    }
    
    .gradient-overlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at 20% 30%, rgba(123,67,255,0.12), transparent 40%),
                 radial-gradient(circle at 80% 70%, rgba(0,191,255,0.08), transparent 40%);
      z-index:-1;
      animation:gradientShift 18s ease-in-out infinite
    }
    
    @keyframes gradientShift{
      0%,100%{transform:scale(1);opacity:.9}
      50%{transform:scale(1.05);opacity:1}
    }

    /* Layout */
    .chatbot-container{
      max-width:1200px;
      margin:0 auto;
      height:100vh;
      display:flex;
      flex-direction:column
    }
    
    .chatbot-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 22px;
      background:rgba(10,10,15,0.9);
      backdrop-filter:blur(12px);
      border-bottom:1px solid rgba(123,67,255,0.2)
    }
    
    .header-left{
      display:flex;
      align-items:center;
      gap:14px
    }
    
    .back-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:40px;
      height:40px;
      border-radius:50%;
      background:rgba(123,67,255,0.18);
      border:1px solid rgba(123,67,255,0.3);
      color:#fff;
      text-decoration:none;
      transition:all 0.3s ease
    }
    
    .back-btn:hover{
      background:rgba(123,67,255,0.3);
      transform:scale(1.05)
    }
    
    .chatbot-avatar{
      width:48px;
      height:48px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      border:2px solid rgba(255,255,255,0.08);
      font-size:1.2rem
    }
    
    .chatbot-info h3{
      font-size:1.15rem;
      margin:0;
      font-weight:600
    }
    
    .chatbot-info p{
      margin:0;
      color:var(--accent);
      font-size:0.9rem;
      display:flex;
      gap:8px;
      align-items:center
    }
    
    .status-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--accent);
      animation:pulse 2s infinite
    }
    
    @keyframes pulse{
      0%,100%{opacity:1;transform:scale(1)}
      50%{opacity:.5;transform:scale(1.2)}
    }
    
    .header-nav{
      display:flex;
      gap:10px
    }
    
    .nav-btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 14px;
      border-radius:18px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.06);
      color:#fff;
      text-decoration:none;
      transition:all 0.3s ease
    }
    
    .nav-btn:hover{
      background:rgba(123,67,255,0.12);
      transform:translateY(-2px)
    }

    .chatbot-content{
      display:flex;
      flex:1;
      overflow:hidden;
      position:relative;
    }
    
    .chat-area{
      flex:1;
      display:flex;
      flex-direction:column;
      transition: width 0.3s ease;
    }
    
    .chatbot-messages{
      flex:1;
      padding:20px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px
    }
    
    .chatbot-messages::-webkit-scrollbar{
      width:7px
    }
    
    .chatbot-messages::-webkit-scrollbar-thumb{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      border-radius:10px
    }

    .chat-message{
      display:flex;
      gap:12px;
      align-items:flex-start;
      animation:messageSlide .28s ease
    }
    
    @keyframes messageSlide{
      from{opacity:0;transform:translateY(8px)}
      to{opacity:1;transform:none}
    }
    
    .chat-message.user{
      flex-direction:row-reverse
    }
    
    .message-avatar{
      width:40px;
      height:40px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
      flex-shrink:0
    }
    
    .message-avatar.bot{
      background:linear-gradient(135deg,var(--primary),var(--secondary))
    }
    
    .message-avatar.user{
      background:rgba(255,255,255,0.12)
    }
    
    .message-content{
      max-width:72%;
      padding:12px 14px;
      border-radius:14px;
      line-height:1.45;
      font-size:0.95rem
    }
    
    .chat-message.bot .message-content{
      background:linear-gradient(135deg, rgba(123,67,255,0.18), rgba(0,191,255,0.12));
      border:1px solid rgba(123,67,255,0.28);
      border-radius:14px 14px 14px 6px
    }
    
    .chat-message.user .message-content{
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:14px 14px 6px 14px
    }
    
    .message-time{
      font-size:0.75rem;
      color:rgba(255,255,255,0.45);
      margin-top:6px
    }
    
    .message-actions{
      display:flex;
      gap:8px;
      margin-top:8px
    }
    
    .message-action{
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.06);
      padding:6px 10px;
      border-radius:12px;
      font-size:0.82rem;
      cursor:pointer;
      transition:all 0.3s ease
    }
    
    .message-action:hover{
      background:rgba(123,67,255,0.12)
    }

    .chatbot-input-area{
      padding:18px;
      background:linear-gradient(180deg, rgba(0,0,0,0.08), rgba(0,0,0,0.04));
      border-top:1px solid rgba(123,67,255,0.08)
    }
    
    .input-attachments{
      display:flex;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:wrap
    }
    
    .attachment-item{
      background:rgba(123,67,255,0.12);
      border:1px solid rgba(123,67,255,0.2);
      padding:6px 10px;
      border-radius:16px;
      display:inline-flex;
      gap:8px;
      align-items:center
    }

    .quick-actions{
      display:flex;
      gap:10px;
      margin-bottom:12px;
      flex-wrap:wrap
    }
    
    .quick-action-btn{
      background:rgba(123,67,255,0.12);
      border:1px solid rgba(123,67,255,0.18);
      padding:8px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:all 0.3s ease
    }
    
    .quick-action-btn:hover{
      background:rgba(123,67,255,0.2);
      transform:translateY(-2px)
    }

    .input-wrapper{
      display:flex;
      gap:10px;
      align-items:flex-end
    }
    
    .input-actions{
      display:flex;
      gap:8px
    }
    
    .input-btn{
      width:46px;
      height:46px;
      border-radius:50%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:rgba(123,67,255,0.12);
      border:1px solid rgba(123,67,255,0.18);
      cursor:pointer;
      position:relative;
      transition:all 0.3s ease
    }
    
    .input-btn:hover{
      background:rgba(123,67,255,0.2);
      transform:scale(1.05)
    }
    
    .input-btn input{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer
    }
    
    .chat-input{
      flex:1;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(123,67,255,0.12);
      background:rgba(255,255,255,0.03);
      color:var(--light);
      min-height:44px;
      max-height:120px;
      resize:none;
      font-family:inherit;
      outline:none;
      transition:all 0.3s ease
    }
    
    .chat-input:focus{
      border-color:var(--primary);
      background:rgba(255,255,255,0.05)
    }
    
    .send-btn{
      width:46px;
      height:46px;
      border-radius:50%;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      border:none;
      color:#fff;
      cursor:pointer;
      transition:all 0.3s ease
    }
    
    .send-btn:hover{
      transform:scale(1.05);
      box-shadow:0 5px 15px rgba(123,67,255,0.4)
    }

    /* Sidebar */
    .chat-sidebar{
      width:300px;
      background:rgba(255,255,255,0.03);
      backdrop-filter:blur(14px);
      border-left:1px solid rgba(123,67,255,0.12);
      padding:18px;
      overflow:auto;
      position:absolute;
      right:0;
      top:0;
      bottom:0;
      transform:translateX(100%);
      transition:transform 0.3s ease;
      z-index:10;
    }
    
    .chat-sidebar.active{
      transform:translateX(0);
    }
    
    .sidebar-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:600;
      margin-bottom:12px
    }
    
    .setting-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid rgba(123,67,255,0.06)
    }
    
    .toggle-switch{
      width:50px;
      height:26px;
      border-radius:30px;
      background:rgba(255,255,255,0.06);
      position:relative;
      border:1px solid rgba(255,255,255,0.06);
      cursor:pointer;
      transition:all 0.3s ease
    }
    
    .toggle-slider{
      position:absolute;
      left:2px;
      top:2px;
      width:20px;
      height:20px;
      background:#fff;
      border-radius:50%;
      transition:all .25s ease
    }
    
    .toggle-switch.active{
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      border-color:transparent
    }
    
    .toggle-switch.active .toggle-slider{
      left:26px
    }

    /* typing indicator */
    .typing-indicator{
      display:flex;
      gap:6px;
      align-items:center
    }
    
    .typing-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--primary);
      animation:typingAnim 1.4s infinite
    }
    
    .typing-dot:nth-child(2){animation-delay:.15s}
    .typing-dot:nth-child(3){animation-delay:.3s}
    
    @keyframes typingAnim{
      0%,60%,100%{transform:translateY(0);opacity:.5}
      30%{transform:translateY(-8px);opacity:1}
    }

    /* responsive */
    @media (max-width:900px){
      .chat-sidebar{
        width:100%;
        transform:translateX(100%);
      }
      
      .chat-sidebar.active{
        transform:translateX(0);
      }
      
      .chatbot-messages{padding:12px}
      .chatbot-header{padding:12px}
    }
  </style>
</head>
<body>
  <div class="gradient-bg"></div>
  <div class="gradient-overlay"></div>

  <div class="chatbot-container">
    <header class="chatbot-header">
      <div class="header-left">
        <a href="index.html" class="back-btn" title="Back to Home">
          <i class="fas fa-arrow-left"></i>
        </a>
        <div class="chatbot-avatar">
          <i class="fas fa-robot"></i>
        </div>
        <div class="chatbot-info">
          <h3>Watson Assistant</h3>
          <p><span class="status-dot"></span> Online - Ready to help</p>
        </div>
      </div>

      <div class="header-nav">
        <a href="#" class="nav-btn" id="openSettings">
          <i class="fas fa-cog"></i> Settings
        </a>
        <a href="index.html" class="nav-btn">
          <i class="fas fa-home"></i> Home
        </a>
      </div>
    </header>

    <div class="chatbot-content">
      <div class="chat-area">
        <main class="chatbot-messages" id="chatbotMessages">
          <div class="chat-message bot">
            <div class="message-avatar bot">
              <i class="fas fa-robot"></i>
            </div>
            <div>
              <div class="message-content">
                Hello! I'm your Watson AI assistant. Ask me for notes, schedules, fee info, faculty contacts and more.
              </div>
              <div class="message-time">Just now</div>
            </div>
          </div>
        </main>

        <div class="chatbot-input-area">
          <div class="input-attachments" id="attachmentsList"></div>
          
          <div class="quick-actions">
            <div class="quick-action-btn" onclick="quickAction('notes')">
              <i class="fas fa-book"></i> Get Notes
            </div>
            <div class="quick-action-btn" onclick="quickAction('schedule')">
              <i class="fas fa-calendar"></i> Exam Schedule
            </div>
            <div class="quick-action-btn" onclick="quickAction('fees')">
              <i class="fas fa-money-bill"></i> Fee Info
            </div>
            <div class="quick-action-btn" onclick="quickAction('faculty')">
              <i class="fas fa-chalkboard-teacher"></i> Faculty
            </div>
          </div>

          <div class="input-wrapper">
            <div class="input-actions">
              <label class="input-btn" title="Attach image">
                <i class="fas fa-image"></i>
                <input type="file" accept="image/*" id="imageInput">
              </label>
              <label class="input-btn" title="Attach file">
                <i class="fas fa-paperclip"></i>
                <input type="file" id="fileInput">
              </label>
              <div class="input-btn" id="voiceBtn" title="Voice Input">
                <i class="fas fa-microphone"></i>
                <span class="voice-indicator" id="voiceIndicator"></span>
              </div>
            </div>

            <textarea class="chat-input" id="chatInput" placeholder="Type your message..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn" title="Send">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="chat-sidebar" id="chatSidebar">
        <div class="sidebar-section">
          <h4 class="sidebar-title">
            <i class="fas fa-cog"></i> Chat Settings
          </h4>

          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-title">Voice Activation</div>
              <div class="setting-description">Enable voice commands</div>
            </div>
            <div class="toggle-switch" id="voiceToggle">
              <div class="toggle-slider"></div>
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-title">Sound Effects</div>
              <div class="setting-description">Play sound on new messages</div>
            </div>
            <div class="toggle-switch" id="soundToggle">
              <div class="toggle-slider"></div>
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-title">Auto-scroll</div>
              <div class="setting-description">Automatically scroll to new messages</div>
            </div>
            <div class="toggle-switch active" id="scrollToggle">
              <div class="toggle-slider"></div>
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-title">Typing Indicators</div>
              <div class="setting-description">Show when Watson is typing</div>
            </div>
            <div class="toggle-switch active" id="typingToggle">
              <div class="toggle-slider"></div>
            </div>
          </div>
        </div>

        <div class="sidebar-section">
          <h4 class="sidebar-title">
            <i class="fas fa-history"></i> Chat History
          </h4>

          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-title">Clear Conversation</div>
              <div class="setting-description">Remove all messages</div>
            </div>
            <button class="quick-action-btn" id="clearChatBtn">Clear</button>
          </div>

          <div class="setting-item">
            <div class="setting-info">
              <div class="setting-title">Export Chat</div>
              <div class="setting-description">Download conversation as .txt</div>
            </div>
            <button class="quick-action-btn" id="exportChatBtn">Export</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------- Configuration ----------------------
    const FLASK_ENDPOINT = '/api/message';

    // Chat state
    let attachments = [];
    let voiceEnabled = false;
    let soundEnabled = false;
    let autoScroll = true;
    let typingEnabled = true;
    let isListening = false;
    let awaitingResponse = false;

    // DOM elements
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatbotMessages = document.getElementById('chatbotMessages');
    const imageInput = document.getElementById('imageInput');
    const fileInput = document.getElementById('fileInput');
    const voiceBtn = document.getElementById('voiceBtn');
    const attachmentsList = document.getElementById('attachmentsList');
    const voiceIndicator = document.getElementById('voiceIndicator');
    const openSettings = document.getElementById('openSettings');
    const chatSidebar = document.getElementById('chatSidebar');
    const clearChatBtn = document.getElementById('clearChatBtn');
    const exportChatBtn = document.getElementById('exportChatBtn');

    const voiceToggle = document.getElementById('voiceToggle');
    const soundToggle = document.getElementById('soundToggle');
    const scrollToggle = document.getElementById('scrollToggle');
    const typingToggle = document.getElementById('typingToggle');

    document.addEventListener('DOMContentLoaded', () => {
      loadConfiguration();
      setupListeners();
      // Welcome message
      setTimeout(() => addBotMessage("Feel free to ask me anything about your academic needs."), 800);
    });

    function setupListeners(){
      // send on click
      sendBtn.addEventListener('click', sendMessage);
      
      // enter to send
      chatInput.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){ 
          e.preventDefault(); 
          sendMessage(); 
        }
      });
      
      // autosize
      chatInput.addEventListener('input', ()=>{
        chatInput.style.height='auto'; 
        chatInput.style.height=Math.min(chatInput.scrollHeight,120)+'px'; 
      });

      imageInput.addEventListener('change', (e)=>{ 
        handleFileAttachment(e.target.files[0],'ðŸ“·'); 
      });
      
      fileInput.addEventListener('change', (e)=>{ 
        handleFileAttachment(e.target.files[0],'ðŸ“Ž'); 
      });

      voiceBtn.addEventListener('click', ()=>{
        if(!voiceEnabled){ 
          showTempMessage('Enable voice in settings first'); 
          return; 
        }
        isListening ? stopVoiceRecognition() : startVoiceRecognition();
      });

      // Settings sidebar toggle
      openSettings.addEventListener('click', (e)=>{ 
        e.preventDefault(); 
        chatSidebar.classList.toggle('active'); 
      });
      
      clearChatBtn.addEventListener('click', clearChat);
      exportChatBtn.addEventListener('click', exportChat);

      voiceToggle.addEventListener('click', ()=>{ 
        voiceEnabled=!voiceEnabled; 
        voiceToggle.classList.toggle('active',voiceEnabled); 
        voiceIndicator.classList.toggle('active', voiceEnabled); 
        saveConfiguration(); 
      });
      
      soundToggle.addEventListener('click', ()=>{ 
        soundEnabled=!soundEnabled; 
        soundToggle.classList.toggle('active',soundEnabled); 
        saveConfiguration(); 
      });
      
      scrollToggle.addEventListener('click', ()=>{ 
        autoScroll=!autoScroll; 
        scrollToggle.classList.toggle('active',autoScroll); 
        saveConfiguration(); 
      });
      
      typingToggle.addEventListener('click', ()=>{ 
        typingEnabled=!typingEnabled; 
        typingToggle.classList.toggle('active',typingEnabled); 
        saveConfiguration(); 
      });
    }

    // ---------------------- Messages ----------------------
    function addUserMessage(text, files=[]){
      const msg = document.createElement('div'); 
      msg.className='chat-message user';
      const filesHtml = files.map(f=>`<div style="margin-bottom:6px">${f.icon} ${f.name}</div>`).join('');
      msg.innerHTML = `
        <div class="message-avatar user"><i class="fas fa-user"></i></div>
        <div>
          <div class="message-content">${escapeHtml(filesHtml + (text||''))}</div>
          <div class="message-time">${timeNow()}</div>
        </div>`;
      chatbotMessages.appendChild(msg); 
      scrollIfNeeded();
    }

    function addBotMessage(text){
      const msg = document.createElement('div'); 
      msg.className='chat-message bot';
      msg.innerHTML = `
        <div class="message-avatar bot"><i class="fas fa-robot"></i></div>
        <div>
          <div class="message-content">${escapeHtml(text)}</div>
          <div class="message-time">${timeNow()}</div>
          <div class="message-actions">
            <div class="message-action" onclick="copyToClipboard('${text.replace(/'/g,"\\'")}')">
              <i class="fas fa-copy"></i> Copy
            </div>
          </div>
        </div>`;
      chatbotMessages.appendChild(msg); 
      scrollIfNeeded();
      if(soundEnabled){ playDing(); }
    }

    function showTyping(){
      if(!typingEnabled) return;
      removeTyping();
      const t = document.createElement('div'); 
      t.className='chat-message bot'; 
      t.id='typingIndicator';
      t.innerHTML = `
        <div class="message-avatar bot"><i class="fas fa-robot"></i></div>
        <div>
          <div class="message-content">
            <div class="typing-indicator">
              <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
            </div>
          </div>
        </div>`;
      chatbotMessages.appendChild(t); 
      scrollIfNeeded();
    }
    
    function removeTyping(){ 
      const el=document.getElementById('typingIndicator'); 
      if(el) el.remove(); 
    }

    function scrollIfNeeded(){ 
      if(autoScroll) chatbotMessages.scrollTop = chatbotMessages.scrollHeight; 
    }

    // ---------------------- Send / Backend ----------------------
    function sendMessage() {
    const text = chatInput.value.trim();
    if(!text && attachments.length===0) return; 
    if(awaitingResponse) return;

    addUserMessage(text, attachments);

    // reset
    chatInput.value=''; 
    chatInput.style.height='auto'; 
    attachments=[]; 
    attachmentsList.innerHTML='';

    // show typing
    showTyping();
    awaitingResponse = true;

    // send to backend
    fetch(FLASK_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
    })
    .then(res => res.json())
    .then(data => {
        removeTyping();
        awaitingResponse = false;
        const reply = data.reply || "I'm sorry, I didn't understand that.";
        addBotMessage(Array.isArray(reply) ? reply.join('\n') : reply);
    })
    .catch(err => {
        removeTyping();
        awaitingResponse = false;
        addBotMessage('Sorry, something went wrong.');
        console.error(err);
    });
}


    // ---------------------- Files ----------------------
    function handleFileAttachment(file, icon){ 
      if(!file) return; 
      attachments.push({name:file.name,file:file,icon:icon}); 
      renderAttachments(); 
    }
    
    function renderAttachments(){ 
      attachmentsList.innerHTML = attachments.map((a,i)=>`
        <div class="attachment-item">
          ${a.icon} ${a.name} 
          <span style="margin-left:8px;cursor:pointer" onclick="removeAttachment(${i})">âœ•</span>
        </div>`).join(''); 
    }
    
    function removeAttachment(i){ 
      attachments.splice(i,1); 
      renderAttachments(); 
    }

    // ---------------------- Quick actions ----------------------
    function quickAction(type){ 
      let m=''; 
      switch(type){
        case 'notes': 
          m='I need notes for Computer Science semester 3'; 
          break; 
        case 'schedule': 
          m='Show me the exam timetable for this semester'; 
          break; 
        case 'fees': 
          m='What is the fee structure for this semester?'; 
          break; 
        case 'faculty': 
          m='I need Computer Science faculty contact details'; 
          break;
      } 
      chatInput.value=m; 
      sendMessage(); 
    }

    // ---------------------- Voice (simple) ----------------------
    let recognition=null;
    function startVoiceRecognition(){ 
      if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){ 
        showTempMessage('Voice not supported in this browser'); 
        return; 
      }
      
      const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition; 
      recognition = new SpeechRec(); 
      recognition.lang='en-IN'; 
      recognition.interimResults=false; 
      recognition.maxAlternatives=1;
      
      recognition.onstart = ()=>{ 
        isListening=true; 
        voiceBtn.classList.add('listening'); 
        voiceIndicator.classList.add('active'); 
        showTempMessage('Listening...'); 
      };
      
      recognition.onresult = (e)=>{ 
        const text = e.results[0][0].transcript; 
        chatInput.value = text; 
        stopVoiceRecognition(); 
        sendMessage(); 
      };
      
      recognition.onerror = (e)=>{ 
        stopVoiceRecognition(); 
        showTempMessage('Voice error'); 
      };
      
      recognition.onend = ()=>{ 
        stopVoiceRecognition(); 
      };
      
      recognition.start();
    }
    
    function stopVoiceRecognition(){ 
      if(recognition){ 
        recognition.stop(); 
        recognition=null; 
      } 
      isListening=false; 
      voiceBtn.classList.remove('listening'); 
      voiceIndicator.classList.remove('active'); 
    }

    // ---------------------- Utilities ----------------------
    function timeNow(){ 
      const d=new Date(); 
      return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); 
    }
    
    function showTempMessage(text){ 
      const el=document.createElement('div'); 
      el.style.cssText='position:fixed;right:24px;bottom:120px;background:linear-gradient(135deg,var(--primary),var(--secondary));padding:10px 14px;border-radius:10px;color:#fff;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,0.5);transition:all 0.3s ease';
      el.textContent=text; 
      document.body.appendChild(el); 
      setTimeout(()=>{ 
        el.style.opacity='0'; 
        el.style.transform='translateY(-12px)'; 
        setTimeout(()=>el.remove(),300); 
      },1800); 
    }
    
    function escapeHtml(str){ 
      if(!str) return ''; 
      return String(str).replace(/[&<>"'`]/g,function(s){
        return{'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[s];
      });
    }

    function copyToClipboard(text){ 
      navigator.clipboard.writeText(text)
        .then(()=>showTempMessage('Copied to clipboard!'))
        .catch(()=>showTempMessage('Copy failed'))
    }

    function clearChat(){ 
      if(!confirm('Clear conversation?')) return; 
      chatbotMessages.innerHTML=''; 
      addBotMessage('Hello! How can I help you today?'); 
    }

    function exportChat(){ 
      let chatText='Watson AI Chatbot Conversation\n\n'; 
      document.querySelectorAll('.chat-message').forEach(m=>{ 
        const isUser=m.classList.contains('user'); 
        const who=isUser?'You':'Watson'; 
        const txt = (m.querySelector('.message-content')||{textContent:''}).textContent.trim(); 
        const time=(m.querySelector('.message-time')||{textContent:''}).textContent; 
        chatText += `${who} (${time}): ${txt}\n\n`; 
      }); 
      
      const blob=new Blob([chatText],{type:'text/plain'}); 
      const url=URL.createObjectURL(blob); 
      const a=document.createElement('a'); 
      a.href=url; 
      a.download=`watson-chat-${new Date().toISOString().split('T')[0]}.txt`; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      URL.revokeObjectURL(url); 
      showTempMessage('Chat exported'); 
    }

    function playDing(){ 
      try{ 
        const audio=new Audio(); 
        audio.src='data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA='; 
        audio.play().catch(()=>{}); 
      }catch(e){}
    }

    // ---------------------- Save/load config ----------------------
    function saveConfiguration() {
    localStorage.setItem('watsonChatbotConfig', JSON.stringify({ voiceEnabled, soundEnabled, autoScroll, typingEnabled }));
}

function loadConfiguration() {
    const s = localStorage.getItem('watsonChatbotConfig');
    if (!s) return;
    const cfg = JSON.parse(s);
    voiceEnabled = !!cfg.voiceEnabled;
    soundEnabled = !!cfg.soundEnabled;
    autoScroll = cfg.autoScroll === undefined ? true : !!cfg.autoScroll;
    typingEnabled = cfg.typingEnabled === undefined ? true : !!cfg.typingEnabled;
    voiceToggle.classList.toggle('active', voiceEnabled);
    soundToggle.classList.toggle('active', soundEnabled);
    scrollToggle.classList.toggle('active', autoScroll);
    typingToggle.classList.toggle('active', typingEnabled);
}
    // Expose some funcs for inline onclick
    window.quickAction = quickAction;
    window.copyToClipboard = copyToClipboard;
    window.removeAttachment = removeAttachment;
  </script>
</body>
</html>
